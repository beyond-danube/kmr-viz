<!DOCTYPE html>
<html>
<head>
    <title>Візуалізація відкритих даних поіменних голосувань Київради</title>

    <meta name="description" content="">
    <meta name="robots" content="noindex, nofollow">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">

    <!-- <script src="js/config.js"></script> -->

    <link rel="stylesheet" href="css/style.css">

    <!-- <script src="js/drawing-constants.js"></script> -->
    <script type="text/javascript"  src="js/data-getter.js"></script>
    <script type="text/javascript" src="js/chart-drawers.js"></script>
    <script type="text/javascript" src="js/drawing-constants.js"></script>
    <script type="text/javascript" src="js/table-drawer.js"></script>
    <script type="text/javascript" src="js/table-named-drawer.js"></script>

    <!-- <link rel="stylesheet" href="css/main.css"> -->


    <!-- <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;800&display=swap" rel="stylesheet"> -->

    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">

    <!--icons-->
    <link rel="apple-touch-icon" sizes="180x180" href="img/logo/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="img/logo/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/logo/favicon-16x16.png">
    <link rel="manifest" href="img/logo/site.webmanifest">
    <link rel="mask-icon" href="img/logo/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="img/logo/favicon.ico">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="img/logo/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">

</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col">
                <h1>Чим займається Київрада</h1>
                <p>На основі відкритих даних щодо <a href="https://kmr.gov.ua/uk/result_golosuvanya">поімених голосувань</a></p>
                <p>
                    — Що це за графіки та звідки дані?<br>
                    — Графіки — це візуалізація голосувань Київради, на основі відкритих даних<br>
                    — Дуже складна діаграма, як її читати?<br>
                    — Ми згрупували дані таким чином, Група → Тема → Голос → Результат<br>
                    — Що значить ширина ліній?<br>
                    — Кількість тем у групі або кількість голосів<br>
                </p>
            </div>
        </div>
    </div>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div  id="docs-loaded-progress-bar-div" style="position: relative; top: 50%;">
                    <p class="lead">Завантажуємо рішення за період</p>
                        <div class="progress">
                        <div class="progress-bar" id="docs-loaded-progress-bar" role="progressbar" style="width: 0%" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
                <div id="sankey_voting" style="height: 70vh; position: relative;">
                </div>                
            </div>
        </div>
    </div>
    <div class="container mt-3">
        <!-- <div class="row mb-4">
            <div class="col-2">
                <select id="year" class="form-select">
                  <option selected>2021</option>
                  <option>2022</option>
                </select>
            </div>
            <div class="col-2">
                <select id="month" class="form-select">
                  <option>01</option>
                  <option selected>02</option>
                  <option>03</option>
                  <option>04</option>
                  <option>05</option>
                  <option>06</option>
                  <option>07</option>
                  <option>08</option>
                  <option>09</option>
                  <option>10</option>
                  <option>11</option>
                  <option>12</option>
                </select>
            </div>
            <div class="col-2">
                <button type="button" class="btn btn-primary" id="submit">Показати</button>
            </div>
        </div> -->
        <div class="row mb-4">
            <div class="col-2">
                <select id="year-from" class="form-select">
                  <option selected>2021</option>
                  <option>2022</option>
                  <option>2023</option>
                </select>
            </div>
            <div class="col-2">
                <select id="month-from" class="form-select">
                  <option selected>01</option>
                  <option>02</option>
                  <option>03</option>
                  <option>04</option>
                  <option>05</option>
                  <option>06</option>
                  <option>07</option>
                  <option>08</option>
                  <option>09</option>
                  <option>10</option>
                  <option>11</option>
                  <option>12</option>
                </select>
            </div>
            <div class="col-1">
            </div>
            <div class="col-2">
                <select id="year-to" class="form-select">
                  <option selected>2021</option>
                  <option>2022</option>
                  <option>2023</option>
                </select>
            </div>
            <div class="col-2">
                <select id="month-to" class="form-select">
                  <option>01</option>
                  <option selected>02</option>
                  <option>03</option>
                  <option>04</option>
                  <option>05</option>
                  <option>06</option>
                  <option>07</option>
                  <option>08</option>
                  <option>09</option>
                  <option>10</option>
                  <option>11</option>
                  <option selected>12</option>
                </select>
            </div>
            <div class="col-2">
                <button type="button" class="btn btn-primary" id="submit">Показати</button>
            </div>
        </div>
        <div class="row row mb-4">
            <div class="col">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="hideTechWorkCheckbox">
                    <label class="form-check-label" for="hideTechWorkCheckbox">Не показувати технічну роботу</label>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <p>
                    — Навіщо цей аналіз? Це про зраду?<br>
                    — Ні, навпаки. Ми раді, що відкриті дані нарешті є і ми можемо начоно побачити чим конкретно займаєються міські структури<br>
                    — Які ваші висновки?<br>
                    — Загальний — інституція Київради в нинішньому форматі не має сенсу<br>
                    — Чому ви так вважаєте?<br>
                    — Більшість тем голосувань це теми про земельні ділянки, кому що віддати в постійне користування, або в аренду. Натомість міські проєкти, такі як транспорт, обговорення забудови з громадськістю, соціальні та міські теми майже не фігурують у голосуваннях<br>
                    — Зможете розповіти детальніше?<br>
                    — Так, нижче детальніша інформація та аналіз<br>
                </p>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <h2>Детальніше про голосування на рішення</h1></div>
                <p>
                    Все, що винесене на голосування, майже ніколи не має голосів Проти<br>
                    Неприйнятиі рішення неприйняті не через те, що частина депутатів Київради проти, а через те, що хтось утримався, не голосував, або не прийшов
                </p>
        </div>
        <div class="row">
            <div class="col-lg-6">
                <h5>Прийняті рішення</h5>
                <div id="results-category-yes" class="pie-chart"></div>
            </div>
            <div class="col-lg-6">
                <h5>Не прийняті рішення</h5>
                <div id="results-category-no" class="pie-chart"></div>
            </div>
            <div class="col-lg-6">
                <h5>Всього голосів</h5>
                <div id="votes-distributon" class="pie-chart"></div>
            </div>
            <div class="col-lg-6">
                <h5>Рішення за період</h5>
                <div id="results-distributon" class="pie-chart"></div>
            </div>
        </div>
        <!-- <div class="row">
            <div class="col-12">
                <h5>Голоси у відсотках</h5>
                <div id="votes-trend-percent" class="bar-chart"></div>
            </div>
        </div> -->
        <!-- <div class="row">
            <div class="col-12">
                <h5>Кількість розглянутих питань</h5>
                <div id="decision-trend" class="bar-chart"></div>
            </div>
        </div> -->
    </div>
    <div class="container-fluid">
        <div class="container">
            <div class="row">
                <div class="col"><h1>Тренди у голосуваннях</h1></div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div id="votes-trend" class="bar-chart"></div>
                <div id="votes-trend-percent" class="bar-chart"></div>
                <div id="theme-trend" class="bar-chart"></div>
                <div id="theme-trend-percent" class="bar-chart"></div>
                <div id="decision-trend" class="bar-chart"></div>
            </div>
        </div>
        <div class="container">
            <div class="row">
                <div class="col"><h1>Окремо про земельні ділянки</h1></div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div id="land-trend" class="bar-chart"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>Хто найчастіше не зʼявляється</h1>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="named-table-checkbox" checked>
        </div>
        <br>
        <p id="named-legend">
            🙋‍♂️ За<br>
            🙅‍♀️ Проти<br>
            🤷 Утримався<br>
            👤 Не голосував<br>
            🥷 Відсутній<br>
        </p>
    </div>
    <div class="container" id="named-table"></div>
    <div class="container">
        <h1>Всі рішення списком</h1>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="all-documents-table-checkbox" checked>
        </div>
        <br>
        <p id="legend">
            🙋‍♂️ За<br>
            🙅‍♀️ Проти<br>
            🤷 Утримався<br>
            👤 Не голосував<br>
            🥷 Відсутній<br>
            📑 Рішення
        </p>
    </div>
    <div class="container-fluid" id="details-tables"></div>

    

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>

    <script>

        let selectedYear = document.getElementById("year")
        let selectedMonth = document.getElementById("month")

        let selectedYearFrom = document.getElementById("year-from")
        let selectedMonthFrom = document.getElementById("month-from")

        let selectedYearTo = document.getElementById("year-to")
        let selectedMonthTo = document.getElementById("month-to")

        let submitButton = document.getElementById("submit")

        let chart = document.getElementById("sankey_voting")

        let barContainer = document.getElementById("docs-loaded-progress-bar-div")
        let bar = document.getElementById("docs-loaded-progress-bar")

        let dataFiles

        let votesByCategory

        let datarows

        let loadedDocs = { current: 0, total: 0 }

        let checkbox = document.getElementById("hideTechWorkCheckbox")

        let detailsTableCheckbox = document.getElementById("all-documents-table-checkbox")

        let namedTableCheckbox = document.getElementById("named-table-checkbox")

        function drawLoadProgress() {
            if(loadedDocs.current < loadedDocs.total) {
                bar.style.width = `${loadedDocs.current/loadedDocs.total*100}%`
                bar.innerText = `${loadedDocs.current}/${loadedDocs.total}`
            }

            setTimeout("drawLoadProgress()", 10);
        }

        // TODO: make it less tricky
        async function getDataForChartRange() {

            barContainer.hidden = false
            chart.innerHTML = ''

            loadedDocs.current = 0

            datarows = []

            let dataFilesToGet = []

            if(selectedYearFrom.value == selectedYearTo.value) {

                let values = dataFiles[selectedYearFrom.value]

                for (const month in values) {
                    if ((parseInt(month) >= parseInt(selectedMonthFrom.value)) && (parseInt(month) <= parseInt(selectedMonthTo.value))) {
                        dataFilesToGet.push(values[month])
                    }
                }
            } else {
                for (const year in dataFiles) {
                    // if (parseInt(year) == parseInt(selectedYearFrom.value)) {
                    //     dataFiles[year].forEach(month => {
                    //         if(parseInt(month) >= selectedMonthFrom) {
                    //             dataFiles[year][month].forEach(document => dataFilesToGet.push(document))
                    //         }
                    //     })
                    // }

                    if (parseInt(year) == parseInt(selectedYearFrom.value)) {
                        for (const month in dataFiles[year]) {
                            if(parseInt(month) >= selectedMonthFrom.value) {
                                dataFilesToGet.push(dataFiles[year][month])
                            }
                        }
                    }
                    else if (parseInt(year) == parseInt(selectedYearTo.value)) {
                        for (const month in dataFiles[year]) {
                            if(parseInt(month) <= selectedMonthTo.value) {
                                dataFilesToGet.push(dataFiles[year][month])
                            }
                        }
                    }
                    else {
                        for (const month in dataFiles[year]) {
                            dataFilesToGet.push(dataFiles[year][month])
                        }                    
                    }
                }
            }

            loadedDocs.total = dataFilesToGet.length

            drawLoadProgress()

            let promises = []

            for (const document of dataFilesToGet) {
                promises.push(getMonthDataFile(document))
            }

            const handleProgress = (result) => {
                loadedDocs.current++
                return result;
            }

            await Promise.all(promises.map(p => p.then(handleProgress))).then(results => { 
                results.forEach(res => res.forEach(entry => datarows.push(entry)))    
            })


            barContainer.hidden = true
        }

        async function getDataForChart() {

            barContainer.hidden = false
            chart.innerHTML = ''

            loadedDocs.current = 0

            datarows = []

            loadedDocs.total = dataFiles[selectedYear.value][selectedMonth.value].length

            drawLoadProgress()

            for (const document of dataFiles[selectedYear.value][selectedMonth.value]) {
                await getDataFile(document).then(res => datarows.push(res)).then(() => loadedDocs.current++) 
            }

            barContainer.hidden = true
        }

        window.addEventListener('load', async () => { 
            dataFiles = await getDateMapByMonth()
            await drawAllCharts()
        })

        submitButton.addEventListener('click', async () => {
            await drawAllCharts()
        })

        async function drawAllCharts() {
            await getDataForChartRange()

            console.log(datarows)

            votesByCategory = getVotingResultsByCategory(datarows)

            if(checkbox.checked) {
                themeToCategoryMap.ORG.forEach(categoty => {
                    if(votesByCategory.hasOwnProperty(categoty)) {
                        delete votesByCategory[categoty]
                    }
                })
            }

            drawChart(votesByCategory)

            console.log(votesByCategory)

            let drawingData = getDrawingData(votesByCategory)

            // draw pie charts for overall selecetd period
            drawPieChart(drawingData.voteChartData.columns(), drawingData.voteChartData.rows(), "votes-distributon")
            drawPieChart(drawingData.resultChartData.columns(), drawingData.resultChartData.rows(), "results-distributon")
            drawPieChart(drawingData.resultsByCategoryData.columns(), drawingData.resultsByCategoryData.rowsYes(), "results-category-yes")
            drawPieChart(drawingData.resultsByCategoryData.columns(), drawingData.resultsByCategoryData.rowsNo(), "results-category-no")

            // draw columns and line charts by month for selected period
            drawColumnChart(drawingData.votesByMonthChartData.columns(), drawingData.votesByMonthChartData.rows(), "votes-trend", "bottom")
            drawColumnChart(drawingData.votesByMonthChartData.columns(), drawingData.votesByMonthChartData.rows(), "votes-trend-percent", "bottom", true)
            drawColumnChart(drawingData.resultsByMonthByCategoryData.columns(), drawingData.resultsByMonthByCategoryData.rows(), "theme-trend", "right")
            drawColumnChart(drawingData.resultsByMonthByCategoryData.columns(), drawingData.resultsByMonthByCategoryData.rows(), "theme-trend-percent", "right", true)

            drawLineChart(drawingData.resultByMonthChartData.columns(), drawingData.resultByMonthChartData.rows(), "decision-trend")

            drawColumnChart(drawingData.landCategoryByMonthChartData.columns(), drawingData.landCategoryByMonthChartData.rows(), "land-trend", "right")

            // draw table for selected period
            let tables = document.getElementById("details-tables")
            tables.innerHTML = ''

            createThemeTables(votesByCategory)

            let namedTable = document.getElementById("named-table")
            namedTable.innerHTML = ''

            drawDpGolosTable(votesByCategory)
        }

        detailsTableCheckbox.addEventListener('click', () => {
            let legend = document.getElementById("legend")
            let tables = document.getElementById("details-tables")

            if(legend.hidden != true) {
                legend.hidden = true
                tables.hidden = true
            } else {
                legend.hidden = false
                tables.hidden = false
            }
        })

        namedTableCheckbox.addEventListener('click', () => {
            let legend = document.getElementById("named-legend")
            let tables = document.getElementById("named-table")

            if(legend.hidden != true) {
                legend.hidden = true
                tables.hidden = true
            } else {
                legend.hidden = false
                tables.hidden = false
            }
        })
        

    </script>
</body>

</html>
